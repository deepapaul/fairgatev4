<?php

namespace Common\UtilityBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * FgCmAttributesetRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FgCmAttributesetRepository extends EntityRepository {

    /**
     * Function to get contact field categories
     *
     * @param int     $clubId      club id
     * @param boolean $fedCategory is fed category
     * @param int     $categoryId  categoryn id
     * @param array   $excludeId   category id to exclude
     *
     * @return array
     */
    public function getAllCategories($clubId, $fedCategory = false, $categoryId = '', $excludeId = array()) {

        $qb = $this->createQueryBuilder('cas')
                ->select('cas.title as categoryName', 'cas.id as categoryId')
                ->where('cas.club=:clubId')
                ->orWhere('cas.isSystem=:systemVal');
        if ($fedCategory == true) {
            $qb->orWhere('cas.id=:categoryId')->setParameter('categoryId', $categoryId);
        }
        if (count($excludeId) > 0) {
            $qb->andWhere('cas.id NOT IN (:catIds)')->setParameter('catIds', $excludeId);
        }
        $qb->orderBy('cas.isSystem', 'desc');
        $qb->addOrderBy('cas.sortOrder', 'asc')->setParameter('clubId', $clubId);
        $qb->setParameter('systemVal', 1);

        return $qb->getQuery()->getResult();
    }

    /**
     * Function to get All Club Contact Fields
     *
     * @param array  $clubArray    club details array
     * @param object $conn         Connection
     * @param int    $showInactive set to get actve and inactive fields
     * @param int    $fieldType    Set 0=> allfields,'Company'=>company fiels only,'companyNoMain'=>company with out main contact,'single'=>single persone fields
     * @param int    $isImages     Set true to get profile image fields
     * @param bool   $isIntranet   Whether contact field is fetched for intranet or not.
     * @param array  $fieldId      Array of selected contact fields if needed.
     *
     * @return array
     */
    public function getAllClubContactFields($clubArray, $conn, $showInactive = 1, $fieldType = 0, $isImages = false, $isIntranet = false, $fieldId = array()) {
        $clubId = $clubArray['clubId'];
        $federationId = $clubArray['federationId'];
        $subFederationId = $clubArray['subFederationId'];
        $correspondanceCategory = $clubArray['correspondanceCategory'];
        $invoiceCategory = $clubArray['invoiceCategory'];
        $reqField = "f5.is_required_type as isRequiredType";
        
        //$inactive=($showInactive==1) ? "OR (f1.is_active = 0 AND f1.club_id = $clubId)":'';
        $inactive = ($showInactive == 1) ? "OR (f5.is_active = 0 AND (f1.club_id = $clubId OR f1.is_system_field = 1))" : '';
        $editableSubFed = $editaleClub = $fieldTypeCat = $fieldTypeCond = '';
        $address = isset($clubArray['address']) ? $clubArray['address'] : 'Address';
        $intranetCond = $selectedIdCondition = "";
        if ($isIntranet) {
            $intranetCond = " AND f5.availability_contact != 'not_available' AND f1.id != 5 ";
        }
        if (count($fieldId) > 0) {
            $selectedIdCondition = ' AND f1.id IN (' . implode(',', $fieldId) . ') ';
        }
        //switch betweet company and single person
        if ($fieldType != '0') {
            if ($fieldType == 'Company') {
                //$fieldTypeCond = ' AND f1.is_company=1';
                $fieldTypeCond = ' f1.is_company=1 AND ';
            } elseif ($fieldType == 'companyNoMain') {
                //$fieldTypeCond = ' AND f1.is_company=1';
                $fieldTypeCond = ' f1.is_company=1 AND ';
                $fieldTypeCat = ' AND f0.id != "1" ';
            } else {
                //$fieldTypeCond = ' AND f1.is_personal=1';
                $fieldTypeCond = ' f1.is_personal=1 AND ';
                $fieldTypeCat = ' AND f0.id != "3" ';
            }
            $editaleClub = " AND f1.availability_club='changable'";
            $editableSubFed = " AND f1.availability_sub_fed='changable'";
        }
        //Contact field overview Page Correspondance, Invoice Categories are shown as Address
        $catIdSelection = ($showInactive == 1) ? "IF(f0.id = $invoiceCategory, $correspondanceCategory, f0.id) AS catId " : "f0.id AS catId";
        $catTitleSelection = ($showInactive == 1) ? "IF(f0.id = $invoiceCategory OR f0.id = $correspondanceCategory, '$address', f0.title ) AS title " : "f0.title AS title";
        $catTitleLangSelection = ($showInactive == 1) ? "IF(f0.id = $invoiceCategory OR f0.id = $correspondanceCategory, '$address', f6.title_lang ) AS catTitleLang " : "f6.title_lang AS catTitleLang";
        $addressType = ($showInactive == 1) ? "AND f1.address_id IS NULL" : '';
        $getProfilLib = ($isImages === true) ? "OR f1.id IN (5,21,68)" : '';
        switch ($clubArray['clubType']) {
            case 'standard_club':
            case 'federation':
                $clubIds = "$clubId";
                $fieldVisibility = "f1.club_id=$clubId ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$clubId' THEN '4' END ) as adb";
                $reqField = "f5.is_required_type as isRequiredType";
                break;
            case 'federation_club':
                $clubIds = "$clubId,$federationId";
                $fieldVisibility = "(f1.club_id=$federationId AND f1.availability_club!='not_available' $editaleClub) OR (f1.club_id=$clubId) ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$clubId' THEN '4' END ) AS adb";
                break;
            case 'sub_federation':
                $clubIds = "$clubId,$federationId";
                $fieldVisibility = "(f1.club_id IN ($clubId,$federationId) AND f1.availability_sub_fed!='not_available' $editableSubFed) OR (f1.club_id=$clubId) ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$clubId' THEN '4' END ) AS adb";
                break;
            case 'sub_federation_club':
                $fieldVisibility = "(f1.club_id IN ($federationId,$subFederationId) AND f1.availability_club!= 'not_available' $editaleClub) OR (f1.club_id=$clubId)";
                $clubIds = "$clubId,$federationId,$subFederationId";
                $sort = "(CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$subFederationId' THEN 3 WHEN '$clubId' THEN '4' END) AS adb";
                break;
        }
        //LEFT JOIN fg_cm_attribute f1 ON (f0.id = f1.attributeset_id $addressType AND ((f1.is_active = 1) $inactive ) $fieldTypeCond AND ((f1.is_system_field = 1 OR f1.is_fairgate_field = 1) OR ($fieldVisibility) $getProfilLib))
        // WHERE ((f1.id IS NOT NULL AND f5.club_id = $clubId) OR f1.id IS NULL ) AND  ((f0.is_system = 1 OR f0.is_fairgate = 1) OR (f0.club_id IN ($clubIds))) $fieldTypeCat

        $fieldsArray = $conn->fetchAll("SELECT $catTitleSelection,$catTitleLangSelection,f6.lang as catLang, $catIdSelection , f0.is_system as isSystem, f0.is_fairgate AS isFairgate,
        f1.id AS attrId, f1.fieldname, f2.fieldname_lang as fieldnameLang, f1.fieldname_short AS fieldnameShort, f1.input_type AS inputType, f1.fieldtype AS fieldtype,
        f1.is_system_field AS isSystemField,f1.is_crucial_system_field AS isCrucialSystemField, f1.is_fairgate_field AS isFairgateField, f1.is_company AS isCompany, f1.is_personal AS isPersonal, f1.availability_sub_fed AS availabilitySubFed,
        f5.is_required_fedmember_subfed AS isRequiredFedmemberSubfed,(CASE WHEN f5.availability_contact != 'not_available' THEN 1 ELSE 0 END) AS isVisibleUser, f1.availability_club AS availabilityClub,
        (CASE WHEN f5.availability_contact = 'changable' THEN 1 ELSE 0 END) AS isChangableUser, f5.is_confirm_contact AS isConfirmContact, (CASE WHEN f5.availability_groupadmin = 'changable' THEN 1 ELSE 0 END) AS isChangableTeamAdmin, f5.is_confirm_teamadmin AS isConfirmTeamadmin,
        f5.is_required_fedmember_club AS isRequiredFedmemberClub,f1.predefined_value AS predefinedValue,f1.addres_type as addressType,f1.address_id as addressId, f5.is_active AS isActive,
        f1.fed_profile_status AS fedProfileStatus, f5.profile_status AS profileStatus, f2.lang AS lang, f1.club_id AS createdBy,f0.sort_order as catSortOrder, f0.club_id AS catClubId,
        $reqField,(case when f1.id is NULL then CONCAT(f0.id,f6.lang) else CONCAT(f0.id,f6.lang,f1.id,f2.lang) end) as reqMem,GROUP_CONCAT(f7.membership_id) as memberships,$sort
        FROM fg_cm_attributeset f0
        LEFT JOIN fg_cm_attribute f1 ON (f0.id = f1.attributeset_id $addressType AND $fieldTypeCond  ((f1.is_system_field = 1 OR f1.is_fairgate_field = 1) OR ($fieldVisibility) $getProfilLib))
        LEFT JOIN fg_cm_club_attribute f5 ON (f5.attribute_id = f1.id AND f5.club_id = $clubId AND ((f5.is_active = 1 OR f1.is_crucial_system_field=1) $inactive ))
        LEFT JOIN fg_cm_attribute_i18n f2 ON (f2.id = f1.id)
        LEFT JOIN fg_cm_attributeset_i18n f6 ON (f6.id = f0.id)
        LEFT JOIN fg_cm_attribute_required f7 ON f7.attribute_id=f1.id AND f7.club_id=$clubId
        WHERE ((f1.id IS NOT NULL AND f5.club_id = $clubId) OR f1.id IS NULL ) AND  ((f0.is_system = 1 OR f0.is_fairgate = 1) OR (f0.club_id IN ($clubIds))) $fieldTypeCat
        $intranetCond $selectedIdCondition
        GROUP BY reqMem
        ORDER BY adb ASC,f0.sort_order ASC, catId ASC, f5.sort_order ASC, attrId ASC");

        return $fieldsArray;
    }

    /**
     * Function to get attribute ids of single person/company type only
     *
     * @param array  $clubArray
     * @param string $fieldType
     * @return string
     */
    public function getAttributeIdsByType($clubIds, $fieldType = 'Company') {
        $conn = $this->getEntityManager()->getConnection();
        $fieldTypeCond = '';
        //switch betweet company and single person
        if ($fieldType != '0') {
            if ($fieldType == 'Company') {
                $fieldTypeCond = ' AND f1.is_company=1 AND f1.is_personal=0';
            } else {
                $fieldTypeCond = ' AND f1.is_company=0 AND f1.is_personal=1';
            }
        }
        $fieldVisibility = "f1.club_id IN (".$clubIds.")";
        $fieldsArray = $conn->fetchAll("SELECT GROUP_CONCAT(f1.id) as attributes,GROUP_CONCAT(CONCAT(f1.id,'-',f1.club_id)) as catAttribute
            FROM fg_cm_attributeset f0
            LEFT JOIN fg_cm_attribute f1 ON (f0.id = f1.attributeset_id $fieldTypeCond AND ((f1.is_system_field = 1 OR f1.is_fairgate_field = 1) OR ($fieldVisibility) OR f1.id IN (5,21,68)))
            LEFT JOIN fg_cm_club_attribute f5 ON (f5.attribute_id = f1.id AND f5.club_id IN ($clubIds) AND (f5.is_active = 1 OR f1.is_crucial_system_field=1 ) )
            LEFT JOIN fg_cm_attribute_required f7 ON f7.attribute_id=f1.id AND f7.club_id IN ($clubIds)
            WHERE ((f1.id IS NOT NULL AND f5.club_id IN ($clubIds)) OR f1.id IS NULL ) AND  ((f0.is_system = 1 OR f0.is_fairgate = 1) OR (f0.club_id IN ($clubIds)))
            ");

        return $fieldsArray[0];
    }

    /**
     * Function to get category title by id
     *
     * @param type $categoryId
     *
     * @return type
     */
    public function getCategoryTitle($categoryId) {
        $qb = $this->createQueryBuilder('cas')
                ->select('cas.title as categoryName', 'cas.id as categoryId')
                ->where('cas.id=:categoryId')
                ->setParameter('categoryId', $categoryId);
        $result = $qb->getQuery()->getResult();

        return $result;
    }

    /**
     * Function to hydrate contact field array
     *
     * @param array $fieldDetails contact field array
     *
     * @return array
     */
    public function fieldItrator($fieldDetails) {
        $attrCatIds = array();
        $preCat = '';
        
        foreach ($fieldDetails as $fieldDetail) {
            $catId = $fieldDetail['catId'];
            $attrId = $fieldDetail['attrId'];
            $attrCatIds[$attrId] = $catId;
            $fieldnameLang = $fieldDetail['fieldnameLang'];
            $attrLang = $fieldDetail['lang'];
            $attrTitle[$attrId][$attrLang] = $fieldnameLang;
            $index = empty($fieldDetail['attrId']) ? rand(1, 10) : $fieldDetail['attrId'];
            if ($preCat == $catId) {
                $catLang = $fieldDetail['catLang'];
                if (empty($titles[$catLang])) {
                    $titles[$catLang] = $fieldDetail['catTitleLang'];
                }
                if (!empty($fieldDetail['memberships'])) {
                    $fieldDetail['memberships'] = array_unique(explode(',', $fieldDetail['memberships']));
                }
                if (!empty($fieldDetail['attrId'])) {
                    $fieldsValue[$index] = $fieldDetail;
                }
            } elseif (!empty($preCat)) {
                $fieldsArray[$preCat]['values'] = $fieldsValue;
                $fieldsArray[$preCat]['title'] = $fieldsTitle;
                $fieldsArray[$preCat]['catId'] = $preCat;
                $fieldsArray[$preCat]['catClubId'] = $catClubId;
                $fieldsArray[$preCat]['isSystem'] = $isSystem;
                $fieldsArray[$preCat]['isFairgate'] = $isFairgate;
                $fieldsArray[$preCat]['titles'] = $titles;
                $fieldsArray[$preCat]['catSortOrder'] = $catSortOrder;
                $fieldsValue = $titles = array();
                if (!empty($fieldDetail['attrId'])) {
                    $fieldsValue[$index] = $fieldDetail;
                }
                $catLang = $fieldDetail['catLang'];
                $titles[$catLang] = $fieldDetail['catTitleLang'];
            } else {
                if (!empty($fieldDetail['memberships'])) {
                    $fieldDetail['memberships'] = array_unique(explode(',', $fieldDetail['memberships']));
                }
                if (!empty($fieldDetail['attrId'])) {
                    $fieldsValue[$index] = $fieldDetail;
                }
                $catLang = $fieldDetail['catLang'];
                if (!isset($titles[$catLang])) {
                    $titles[$catLang] = $fieldDetail['catTitleLang'];
                }
            }
            $fieldsTitle = $fieldDetail['title'];
            $catTitle = $fieldDetail['catTitleLang'];
            $catLang = $fieldDetail['catLang'];
            $catSortOrder = $fieldDetail['catSortOrder'];
            $catClubId = $fieldDetail['catClubId'];
            $isSystem = $fieldDetail['isSystem'];
            $isFairgate = $fieldDetail['isFairgate'];
            $index = empty($fieldDetail['attrId']) ? rand(1, 10) : $fieldDetail['attrId'];
            $preCat = $catId;
        }
        if (!empty($preCat)) {
            $fieldsArray[$preCat]['values'] = $fieldsValue;
            $fieldsArray[$preCat]['title'] = $fieldsTitle;
            $fieldsArray[$preCat]['catId'] = $preCat;
            $fieldsArray[$preCat]['catClubId'] = $catClubId;
            $fieldsArray[$preCat]['titles'] = $titles;
            $fieldsArray[$preCat]['catSortOrder'] = $catSortOrder;
            $fieldsArray[$preCat]['isSystem'] = $isSystem;
            $fieldsArray[$preCat]['isFairgate'] = $isFairgate;
            $fieldsValue = array();
        }

        return array('fieldsArray' => $fieldsArray, 'attrTitles' => $attrTitle, 'attrCatIds' => $attrCatIds);
    }

    /**
     * Function to get All Club Contac tFields For Overview
     *
     * @param array  $clubArray    club details array
     * @param object $conn         Connection
     * @param int    $showInactive set to get actve and inactive fields
     *
     * @return array
     */
    public function getAllClubContactFieldsForOverview($clubArray, $conn, $defaultLang, $showInactive = 1, $defaultSystemLang = 'de') {
        $clubId = $clubArray['clubId'];
        $federationId = $clubArray['federationId'];
        $subFederationId = $clubArray['subFederationId'];
        $isVisible = "";
        switch ($clubArray['clubType']) {
            case 'standard_club':
            case 'federation':
                $clubIds = "$clubId";
                $fieldVisibility = "f1.club_id=$clubId ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$clubId' THEN '4' END ) as adb";
                $isVisible = ")";
                break;
            case 'federation_club':
                $clubIds = "$federationId";
                $fieldVisibility = "(f1.club_id=$federationId AND f1.availability_club IN ('changable', 'visible')) OR (f1.club_id=$clubId) ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$clubId' THEN '4' END ) AS adb";
                $isVisible = "AND f1.availability_club IN ('changable', 'visible')) || ($clubId = f1.club_id) ";
                break;
            case 'sub_federation':
                $clubIds = "$federationId";
                $fieldVisibility = "(f1.club_id IN ($clubId,$federationId) AND f1.availability_sub_fed IN ('changable', 'visible')) OR (f1.club_id=$clubId) ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$clubId' THEN '4' END ) AS adb";
                $isVisible = "AND f1.availability_sub_fed IN ('changable', 'visible')) || ($clubId = f1.club_id)";
                break;
            case 'sub_federation_club':
                $fieldVisibility = "(f1.club_id IN ($federationId,$subFederationId) AND f1.availability_club IN ('changable', 'visible')) OR (f1.club_id=$clubId)";
                $clubIds = "$federationId,$subFederationId";
                $sort = "(CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$subFederationId' THEN 3 WHEN '$clubId' THEN '4' END) AS adb";
                $isVisible = "AND f1.availability_club IN ('changable', 'visible')) || ($clubId = f1.club_id) ";
                break;
        }
        $fieldsArray = $conn->fetchAll("SELECT f0.id as attributeSetId, IF(f1.is_system_field = 1, f0.club_id, f1.club_id) as club_id,IF(f0i18.title_lang IS NULL OR f0i18.title_lang='', f0.title, f0i18.title_lang) as title,"
                . " f1.id as attributeId,IF(f1i18.fieldname_lang IS NULL OR f1i18.fieldname_lang='', f1.fieldname, f1i18.fieldname_lang) as fieldnameShort,"
                . " f1.input_type as inputType,f0.is_system as catSystem,f1.is_system_field, $sort,ca.sort_order as itemSortOrder "
                . " FROM fg_cm_attributeset f0"
                . " LEFT JOIN fg_cm_attributeset_i18n f0i18 ON f0i18.id = f0.id AND (CASE WHEN (f0.is_system=1) THEN (f0i18.lang = '$defaultSystemLang') ELSE (f0i18.lang = '$defaultLang') END)"
                . " INNER JOIN fg_cm_attribute f1 ON (f0.id = f1.attributeset_id AND ((f1.is_system_field = 1 OR f1.is_fairgate_field = 1) OR ($fieldVisibility)))"
                . " LEFT JOIN fg_cm_attribute_i18n f1i18 ON f1i18.id = f1.id AND (IF((f1.is_system_field = 1), f1i18.lang = '$defaultSystemLang',f1i18.lang = '$defaultLang'))"
                . " INNER JOIN fg_cm_club_attribute ca ON f1.id=ca.attribute_id AND ca.club_id=$clubId AND (ca.is_active=1 OR f1.is_crucial_system_field=1)"
                . " WHERE (f0.is_system = 1 OR f0.is_fairgate = 1) OR (f0.club_id IN ($clubIds) $isVisible"
                . " ORDER BY f0.is_system DESC,f0.sort_order ASC,f0.id ASC,ca.sort_order ASC");

        return $fieldsArray;
    }

    /**
     * Function to get attribute details
     *
     * @param int    $attibuteId AttributeId
     * @param array  $clubArray  Club details array
     * @param object $conn       Connection
     *
     * @return array
     */
    public function getAttributeDetails($attibuteId, $clubArray, $conn, $allDataFlag = 0) {
        $clubId = $clubArray['clubId'];
        $federationId = $clubArray['federationId'];
        $subFederationId = $clubArray['subFederationId'];
        $clubDefaultLang = $clubArray['clubDefaultLang'];
        $clubDefaultSystemLang = $clubArray['clubDefaultSystemLang'];
        $correspondanceCategory = $clubArray['correspondanceCategory'];
        $invoiceCategory = $clubArray['invoiceCategory'];
        
        switch ($clubArray['clubType']) {
            case 'standard_club':
            case 'federation':
                $clubIds = "$clubId";
                $fieldVisibility = "f1.club_id=$clubId ";
                break;
            case 'federation_club':
                $clubIds = "$clubId,$federationId";
                $fieldVisibility = "(f1.club_id=$federationId AND f1.availability_club = 'changable' ) OR (f1.club_id=$clubId) ";
                break;
            case 'sub_federation':
                $clubIds = "$clubId,$federationId";
                $fieldVisibility = "(f1.club_id IN ($clubId,$federationId) AND f1.availability_sub_fed IN ('changable', 'visible')) OR (f1.club_id=$clubId) ";
                break;
            case 'sub_federation_club':
                $clubIds = "$clubId,$federationId,$subFederationId";
                $fieldVisibility = "(f1.club_id IN ($federationId,$subFederationId) AND f1.availability_club = 'changable') OR (f1.club_id=$clubId)";
                break;
        }
        $allData = ($allDataFlag == 0) ? ' AND (f1.id = ' . $attibuteId . ')' : '';
        $query = "SELECT 
                    f1.id AS attrId, f1.attributeset_id AS catId, f1.fieldname, f1.fieldname_short AS fieldnameShort, f1.input_type AS inputType, f1.fieldtype AS fieldtype,
                    f1.is_system_field AS isSystemField, f1.is_fairgate_field AS isFairgateField, f1.is_company AS isCompany, f1.is_personal AS isPersonal, 
                    f1.availability_sub_fed AS availabilitySubFed,f1.availability_club AS availabilityClub,f1.predefined_value AS predefinedValue,f1.addres_type as addressType,f1.address_id as addressId,
                    f3.is_required_fedmember_subfed AS isRequiredFedmemberSubfed,f3.is_required_fedmember_club AS isRequiredFedmemberClub,f3.is_active AS isActive,f3.is_required_type as isRequiredType,
                    GROUP_CONCAT(f4.membership_id) as reqdMemberships,
                    (SELECT f5.attributeset_id FROM fg_cm_attribute AS f5 WHERE f5.id=$attibuteId) AS currentCatId
                    FROM fg_cm_attribute f1
                    LEFT JOIN fg_cm_attributeset f0 ON (f1.attributeset_id=f0.id AND (f0.is_system = 1 OR f0.is_fairgate = 1) OR (f0.club_id IN (:clubIds)))
                    LEFT JOIN fg_cm_club_attribute f3 ON f3.attribute_id=f1.id AND f3.club_id=$clubId
                    LEFT JOIN fg_cm_attribute_required f4 ON f4.attribute_id=f1.id AND f4.club_id=$clubId
                    WHERE ((f3.is_active = 1 OR f1.is_crucial_system_field=1 )AND ((f1.is_system_field = 1 OR f1.is_fairgate_field = 1) OR ($fieldVisibility))$allData)
                    GROUP BY f1.id";
        $detailsArray = $conn->fetchAll($query, array('clubIds' => $clubIds));

        return $detailsArray;
    }

    /**
     * Function to group contactfields
     * @param type $detailsArray
     * @return type
     */
    public function groupContactFieldsByCategory($detailsArray) {
        $catArr = array();
        foreach ($detailsArray as $key => $val) {
            $catArr[$val['catId']]['values'][$val['attrId']] = $val;
        }
        $detailsArray = array('fieldsArray' => $catArr);

        return $detailsArray;
    }

    /**
     * Function to get All Club Contact Fields
     *
     * @param type $clubArray         club details array
     * @param type $conn              Connection
     * @param type $showInactive      set to get actve and inactive fields
     * @param type $fieldType         Set 0=> allfields,'Company'=>company fiels only,'companyNoMain'=>company with out main contact,'single'=>single persone fields
     * @param type $defaultLang       Default language
     * @param type $defaultSystemLang Default system language
     * @param type $contactId         Contact id
     * @param type $seperateAddress   Community flag
     * @param type $isImages          Set true to get profile image fields
     *
     * @return array
     */
    public function getAllPersonalContactFields($clubArray, $conn, $showInactive = 1, $fieldType = 0, $defaultLang, $defaultSystemLang = 'de', $contactId, $seperateAddress = 0, $isImages = false, $myGroups = array(), $myadminGroups = array(), $applicationArea = 'backend') {
        $clubId = $clubArray['clubId'];
        $federationId = $clubArray['federationId'];
        $subFederationId = $clubArray['subFederationId'];
        $correspondanceCategory = $clubArray['correspondanceCategory'];
        $invoiceCategory = $clubArray['invoiceCategory'];
        $reqField = "f5.is_required_type as isRequiredType";
        $inactive = ($showInactive == 1) ? "OR (f5.is_active = 0 AND f1.club_id = $clubId)" : '';
        $fieldTypeCat = $fieldTypeCond = '';
        $address = isset($clubArray['address']) ? $clubArray['address'] : 'Address';
        //switch betweet company and single person
        if ($fieldType != '0') {
            if ($fieldType == 'Company') {
                $fieldTypeCond = ' AND f1.is_company=1';
            } elseif ($fieldType == 'companyNoMain') {
                $fieldTypeCond = ' AND f1.is_company=1';
                $fieldTypeCat = ' AND f0.id != "1" ';
            } else {
                $fieldTypeCond = ' AND f1.is_personal=1';
                $fieldTypeCat = ' AND f0.id != "3" ';
            }
        }
        //Contact field overview Page Correspondance, Invoice Categories are shown as Address
        $catIdSelection = "IF(f0.id = $invoiceCategory AND $seperateAddress = 0, $correspondanceCategory, f0.id) AS catId ";
        $catTitleSelection = "IF((f0.id = $invoiceCategory OR f0.id = $correspondanceCategory) AND $seperateAddress = 0, '$address', COALESCE(f6.title_lang,f0.title) ) AS title ";
        $catTitleLangSelection = "IF((f0.id = $invoiceCategory OR f0.id = $correspondanceCategory) AND $seperateAddress = 0, '$address', f6.title_lang ) AS catTitleLang ";
        $addressType = ($seperateAddress == 0) ? "AND f1.address_id IS NULL" : '';
        $getProfilLib = '';

        if ($seperateAddress == 1) {
            $currentContact = $clubArray['contactid'];
            $isAdmin = ($applicationArea == 'backend' && ($clubArray['isSuperAdmin'] || $clubArray['isClubAdmin'])) ? '1' : '0'; //If the user is a super admin or club admin

            $groupAdmin = $groupMember = 0;
            //if the specified contact is a member of the team where i am a admin.
            if (count($myadminGroups) > 0) {
                $groupAdminQuery = "SELECT contact_id FROM fg_rm_role_contact rc
                                        LEFT JOIN fg_rm_category_role_function crf ON crf.id = rc.fg_rm_crf_id
                                        LEFT JOIN fg_rm_role r ON r.id = crf.role_id
                                        WHERE crf.role_id IN ( " . implode(',', $myadminGroups) . ") AND r.type IN ('T','W') AND r.is_active=1
                                                AND rc.assined_club_id = $clubId AND contact_id IN ($contactId)";
                $groupAdmin = count($conn->fetchAll($groupAdminQuery));
            }

            if ($applicationArea == 'internal' && ($clubArray['isSuperAdmin'] || $clubArray['isClubAdmin'])) {
                $groupAdmin = 1;
            }

            //if the specified contact is a member of the team where i am a member.
            if (count($myGroups) > 0) {
                $groupMemberQuery = "SELECT contact_id FROM fg_rm_role_contact rc
                                        LEFT JOIN fg_rm_category_role_function crf ON crf.id = rc.fg_rm_crf_id
                                        LEFT JOIN fg_rm_role r ON r.id = crf.role_id
                                        WHERE crf.role_id IN ( " . implode(',', $myGroups) . ") AND r.type IN ('T','W') AND r.is_active=1
                                                AND rc.assined_club_id = $clubId AND contact_id IN ($contactId)";
                $groupMember = count($conn->fetchAll($groupMemberQuery));
            }

            $privacyCondition = "CASE "
                    . "WHEN ($isAdmin) THEN 1 "
                    . "WHEN ($currentContact = $contactId AND availability_contact != 'not_available') THEN 2 "
                    . "WHEN ($groupAdmin AND availability_groupadmin != 'not_available') THEN 3 "
                    . "WHEN (f5.is_set_privacy_itself = 1 AND $groupMember AND f8.privacy = 'team') THEN 4 "
                    . "WHEN (f5.is_set_privacy_itself = 0 AND $groupMember AND f5.privacy_contact = 'team') THEN 5 "
                    . "WHEN (f5.is_set_privacy_itself = 1 AND (f8.privacy = 'community')) THEN 6 "
                    . "WHEN (f5.is_set_privacy_itself = 1 AND f8.privacy IS NULL AND f5.privacy_contact = 'community') THEN 7 "
                    . "WHEN (f5.is_set_privacy_itself = 1 AND f8.privacy IS NULL AND $groupMember AND f5.privacy_contact = 'team') THEN 8 "
                    . "WHEN (f5.is_set_privacy_itself = 0 AND f5.privacy_contact = 'community') THEN 9 "
                    . "ELSE 0 "
                    . 'END AS visibility,';
            $privacyCondition.= 'availability_contact,availability_groupadmin,';
            $joinCondition = '';
            $having = 'HAVING visibility > 0';

            $showConfirmationData = ",CASE "
                    . "WHEN ($isAdmin AND f10.value IS NOT NULL) THEN 1 "
                    . "WHEN (is_confirm_teamadmin AND $groupAdmin AND availability_groupadmin != 'not_visible' AND f10.value IS NOT NULL) THEN 1 "
                    . "WHEN ( (is_confirm_teamadmin OR is_confirm_contact) AND ($currentContact = $contactId) AND (availability_contact != 'not_available' OR availability_groupadmin != 'not_visible') AND f10.value IS NOT NULL) THEN 1 "
                    . "ELSE 0 "
                    . "END AS showConfirmationData";
        } else {
            $privacyCondition = '';
            $having = '';
            $joinCondition = "AND f5.is_set_privacy_itself = 1";
            $showConfirmationData = '';
        }

        $ownClub = 'master_club_' . $clubId;
        $ownFieldJoin = "f9.contact_id";
        switch ($clubArray['clubType']) {
            case 'standard_club':
            case 'federation':
                $clubIds = "$clubId";
                if ($clubArray['clubType'] == 'federation') {
                    $ownClub = 'master_federation_' . $clubId;
		    $ownFieldJoin = 'f9.fed_contact_id';
                }
                $fieldVisibility = "f1.club_id=$clubId ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$clubId' THEN '4' END )";
                $reqField = "f5.is_required_type as isRequiredType";
                break;
            case 'federation_club':
                $clubIds = "$clubId,$federationId";
                $fieldVisibility = "(f1.club_id=$federationId AND f1.availability_club IN ('changable', 'visible')) OR (f1.club_id=$clubId) ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$clubId' THEN '4' END )";
                break;
            case 'sub_federation':
                $ownClub = 'master_federation_' . $clubId;
                $clubIds = "$clubId,$federationId";
                $fieldVisibility = "(f1.club_id IN ($clubId,$federationId) AND f1.availability_sub_fed IN ('changable', 'visible')) OR (f1.club_id=$clubId) ";
                $sort = "( CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$clubId' THEN '4' END )";
                break;
            case 'sub_federation_club':
                $fieldVisibility = "(f1.club_id IN ($federationId,$subFederationId) AND f1.availability_club IN ('changable', 'visible')) OR (f1.club_id=$clubId)";
                $clubIds = "$clubId,$federationId,$subFederationId";
                $sort = "(CASE f0.club_id WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$subFederationId' THEN 3 WHEN '$clubId' THEN '4' END)";
                break;
        }

        $queryString = "SELECT $catTitleSelection,$catTitleLangSelection,f6.lang as catLang, $catIdSelection , f0.is_system as isSystem, f0.is_fairgate AS isFairgate,f0.club_id,
                        fc.is_stealth_mode,f5.is_set_privacy_itself,f1.id AS attrId, COALESCE(f2.fieldname_lang, f1.fieldname) AS fieldname, f2.fieldname_lang as fieldnameLang, f1.fieldname_short AS fieldnameShort, f1.input_type AS inputType, f1.fieldtype AS fieldtype,
                        IF(f5.is_set_privacy_itself =1,IF(f8.privacy IS NULL OR f8.privacy='', f5.privacy_contact, f8.privacy),f5.privacy_contact) as privacySettings,
                        f1.is_system_field AS isSystemField, f1.is_fairgate_field AS isFairgateField, f1.is_company AS isCompany, f1.is_personal AS isPersonal, f1.availability_sub_fed AS isVisibleSubfed,
                        f1.availability_sub_fed AS availabilitySubFed, f5.is_required_fedmember_subfed AS isRequiredFedmemberSubfed, f1.availability_club AS availabilityClub,
                        f5.is_required_fedmember_club AS isRequiredFedmemberClub,f1.predefined_value AS predefinedValue,f1.addres_type as addressType,f1.address_id as addressId, f5.is_active AS isActive,
                        f1.fed_profile_status AS fedProfileStatus, f5.profile_status AS profileStatus, f2.lang AS lang, f1.club_id AS createdBy,f0.sort_order as catSortOrder, f0.club_id AS catClubId,
                        $reqField,
                        (case when f1.id is NULL then CONCAT(f0.id,COALESCE(f6.lang,'$defaultSystemLang')) else CONCAT(f0.id,COALESCE(f6.lang,'$defaultSystemLang'),f1.id,COALESCE(f2.lang,'$defaultSystemLang')) end) as reqMem,
                        GROUP_CONCAT(f7.membership_id) as memberships,$sort as adb, CONCAT('sort-',$sort, IF(f0.id = $invoiceCategory AND $seperateAddress = 0, 3, f0.sort_order), IF((f0.id = $invoiceCategory AND $seperateAddress = 0), 2, f0.id)) as dummyId,
                        $privacyCondition
                        f10.value AS changedValue
                        $showConfirmationData
                        FROM fg_cm_attributeset f0
                        LEFT JOIN fg_cm_attribute f1 ON (f0.id = f1.attributeset_id $addressType $fieldTypeCond AND ((f1.is_system_field = 1 OR f1.is_fairgate_field = 1) OR ($fieldVisibility) $getProfilLib))
                        LEFT JOIN fg_cm_club_attribute f5 ON (f5.attribute_id = f1.id AND f5.club_id = $clubId $joinCondition AND ((f5.is_active = 1) $inactive ))
                        LEFT JOIN fg_cm_attribute_i18n f2 ON (f2.id = f1.id) AND (IF((f1.is_system_field = 1), f2.lang = '$defaultSystemLang',f2.lang = '$defaultLang'))
                        LEFT JOIN fg_cm_attributeset_i18n f6 ON (f6.id = f0.id) AND (CASE WHEN (f0.is_system=1) THEN (f6.lang = '$defaultSystemLang') ELSE (f6.lang = '$defaultLang') END)
                        LEFT JOIN fg_cm_attribute_required f7 ON f7.attribute_id=f1.id AND f7.club_id=$clubId
                        LEFT JOIN fg_cm_contact_privacy f8 ON f8.attribute_id = f1.id AND f8.contact_id = $contactId
                        LEFT JOIN $ownClub f9 ON $ownFieldJoin = f8.contact_id
                        LEFT JOIN fg_cm_contact fc ON fc.id= $ownFieldJoin
                        LEFT JOIN (SELECT * FROM `fg_cm_change_toconfirm` ORDER BY `date` DESC) f10 ON f10.contact_id = $contactId AND f10.attribute_id = f1.id AND f10.club_id = $clubId AND f10.type = 'change' AND f10.confirm_status = 'NONE'
                        WHERE ((f1.id IS NOT NULL AND f5.club_id = $clubId)) AND  ((f0.is_system = 1 OR f0.is_fairgate = 1) OR (f0.club_id IN ($clubIds))) $fieldTypeCat
                        GROUP BY reqMem
                        $having
                        ORDER BY adb ASC,f0.sort_order ASC, catId ASC, f5.sort_order ASC, attrId ASC";
        $fieldsArray = $conn->fetchAll($queryString);

        return $fieldsArray;
    }

    /**
     * Function to get the contact profile options
     *
     * @param array  $clubArray    club details array
     * @param object $conn         Connection
     *
     * @return array
     */
    public function getContactProfileOptions($clubArray, $conn) {
        $clubId = $clubArray['clubId'];
        $federationId = $clubArray['federationId'];
        $subFederationId = $clubArray['subFederationId'];
        $correspondanceCategory = $clubArray['correspondanceCategory'];
        $invoiceCategory = $clubArray['invoiceCategory'];
        $clubDefaultLanguage = $clubArray['defSysLang'];
        $clubDefaultSystemLang = $clubArray['sysLang'];
        $catCommunication = $clubArray['catCommunication'];
        $corrLangId = $clubArray['corrLangId'];
        $clubLanguages = $clubArray['clubLanguages'];

        $address = isset($clubArray['address']) ? $clubArray['address'] : 'Address';

        switch ($clubArray['clubType']) {
            case 'standard_club':
            case 'federation':
                $clubIds = "$clubId";
                $fieldVisibility = "f1.club=$clubId ";
                $sort = "( CASE IDENTITY(f0.club) WHEN 1 THEN '1' WHEN '$clubId' THEN '4' END ) as adb";
                break;
            case 'federation_club':
                $clubIds = "$clubId,$federationId";
                $fieldVisibility = "(f1.club=$federationId AND f1.availabilityClub<>'not_available') OR (f1.club=$clubId) ";
                $sort = "( CASE IDENTITY(f0.club) WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$clubId' THEN '4' END ) AS adb";
                break;
            case 'sub_federation':
                $clubIds = "$clubId,$federationId";
                $fieldVisibility = "(f1.club IN ($clubId,$federationId) AND f1.availabilitySubFed<>'not_available') OR (f1.club=$clubId) ";
                $sort = "( CASE IDENTITY(f0.club) WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$clubId' THEN '4' END ) AS adb";
                break;
            case 'sub_federation_club':
                $fieldVisibility = "(f1.club IN ($federationId,$subFederationId) AND f1.availabilityClub<>'not_available') OR (f1.club=$clubId)";
                $clubIds = "$clubId,$federationId,$subFederationId";
                $sort = "(CASE IDENTITY(f0.club) WHEN 1 THEN '1' WHEN '$federationId' THEN '2' WHEN '$subFederationId' THEN 3 WHEN '$clubId' THEN '4' END) AS adb";
                break;
        }


        $selectColumns = array(
            "(CASE WHEN f0.id = $invoiceCategory THEN $correspondanceCategory ELSE f0.id END) AS catId",
            "(CASE WHEN f0.id = $invoiceCategory OR f0.id = $correspondanceCategory THEN '$address' WHEN f0i18n.titleLang!='' AND f0i18n.titleLang IS NOT NULL THEN f0i18n.titleLang ELSE f0.title END) AS catTitle",
            'IDENTITY(f0.club) AS clubId',
            'f1.id AS attributeId',
            'f1.isSystemField AS isSystemField',
            'f1.isFairgateField AS isFairgateField',
            "(CASE WHEN f1i18n.fieldnameLang!='' AND f1i18n.fieldnameLang IS NOT NULL THEN f1i18n.fieldnameLang ELSE f1.fieldname END) AS fieldName",
            'f2.id AS clubAttributeId',
            'f2.privacyContact AS privacyContact',
            'f2.isSetPrivacyItself AS isSetPrivacyItself',
            'f2.availabilityContact AS availabilityContact',
            'f2.isConfirmContact AS isConfirmContact',
            'f2.availabilityGroupadmin AS availabilityGroupadmin',
            'f2.isConfirmTeamadmin AS isConfirmTeamadmin',
        );
        $queryBuilder = $this->createQueryBuilder('f0');
        $queryBuilder->select(implode(',', $selectColumns));

        $queryBuilder->leftJoin("CommonUtilityBundle:FgCmAttributesetI18n", "f0i18n", "WITH", "(f0.id = f0i18n.id AND ( (f0.isSystem = 1 AND f0i18n.lang = '$clubDefaultSystemLang') OR (f0.isSystem = 0 AND f0i18n.lang = '$clubDefaultLanguage'))) ");
        $queryBuilder->join("CommonUtilityBundle:FgCmAttribute", "f1", "WITH", "(f0.id = f1.attributeset AND f1.address IS NULL AND ((f1.isSystemField = 1 OR f1.isFairgateField = 1) OR ($fieldVisibility) )) ");
        $queryBuilder->leftJoin("CommonUtilityBundle:FgCmAttributeI18n", "f1i18n", "WITH", "(f1.id = f1i18n.id AND ((f1.isSystemField = 1 AND f1i18n.lang = '$clubDefaultSystemLang') OR (f1.isSystemField = 0 AND f1i18n.lang = '$clubDefaultLanguage') )) ");
        $queryBuilder->join("CommonUtilityBundle:FgCmClubAttribute", "f2", "WITH", "(f2.attribute = f1.id AND f2.club = $clubId AND ((f2.isActive = 1 OR f1.isCrucialSystemField=1) OR (f2.isActive = 0 AND (f1.club = $clubId OR f1.isSystemField = 1)) ))");
        $queryBuilder->andWhere("((f1.id IS NOT NULL AND f2.club = $clubId) OR f1.id IS NULL ) AND  ((f0.isSystem = 1 OR f0.isFairgate = 1) OR (f0.club IN ($clubIds)))");

        //Remove the correspondance language when there is only one language for the club
        if (count($clubLanguages) == 1) {
            $queryBuilder->andWhere("f1.id != $corrLangId");
        }

        $queryBuilder->orderBy('f1.club', 'ASC'); //since the above sort not working; this will also give the smae result
        $queryBuilder->addOrderBy('f0.sortOrder', 'ASC');
        $queryBuilder->addOrderBy('catId', 'ASC');
        $queryBuilder->addOrderBy('f2.sortOrder', 'ASC');
        $queryBuilder->addOrderBy('attributeId', 'ASC');

        $result = $queryBuilder->getQuery()->getArrayResult();
        $contactDetailArray = array();
        $contactCategoryArray = array();
        foreach ($result as $key => $contactFieldData) {
            $categoryId = $contactFieldData['catId'];
            if (!in_array($categoryId, $contactCategoryArray)) {
                $contactCategoryArray[] = $categoryId;
            }

            $index = array_search($categoryId, $contactCategoryArray);
            $contactDetailArray[$index]['catId'] = $categoryId;
            $contactDetailArray[$index]['categoryName'] = $contactFieldData['catTitle'];

            $contactDetailArray[$index]['fields'][] = array(
                'categoryId' => $contactFieldData['catId'],
                'attributeId' => $contactFieldData['attributeId'],
                'isSystemField' => $contactFieldData['isSystemField'],
                'isFairgateField' => $contactFieldData['isFairgateField'],
                'fieldName' => $contactFieldData['fieldName'],
                'clubAttributeId' => $contactFieldData['clubAttributeId'],
                'privacyContact' => $contactFieldData['privacyContact'],
                'isSetPrivacyItself' => $contactFieldData['isSetPrivacyItself'],
                'availabilityContact' => $contactFieldData['availabilityContact'],
                'isConfirmContact' => $contactFieldData['isConfirmContact'],
                'availabilityGroupadmin' => $contactFieldData['availabilityGroupadmin'],
                'isConfirmTeamadmin' => $contactFieldData['isConfirmTeamadmin']
            );
        }
        return $contactDetailArray;
    }

}
